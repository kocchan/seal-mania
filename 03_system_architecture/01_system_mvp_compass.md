# システムMVP 設計方針書

## 1. はじめに
システムMVP開発における機能範囲、データ取得手法、および技術選定の指針をまとめたものである。
初期リリース（MVP）では、「開発スピード」と「運用コストの最小化」を最優先事項とする。

---

## 2. MVPの機能スコープ：在庫情報の取得元について

### 現状の課題
当初、各店舗の公式サイトやPOSデータからの直接的な在庫情報取得（スクレイピング等）を検討したが、以下の理由によりMVP段階での実装は**困難**と判断した。
* 店舗サイトごとの構造が異なり、開発工数が膨大になる。
* 多くのサイトで強力なスクレイピング対策（WAF、reCAPTCHA等）が導入されている。
* そもそもリアルタイムの在庫情報をWeb公開していない店舗が多い。

### 決定事項：X（旧Twitter）の投稿を活用する
店舗公式ではなく、ユーザーの投稿（口コミ）を在庫情報のプロキシ（代替指標）として利用する。
* **アプローチ:** 特定のキーワード（例：「店舗名 入荷」「商品名 売ってた」）を含む投稿を収集し、在庫ありの可能性が高い情報を抽出する。
* **メリット:** 複数の店舗・商品を横断的に、かつリアルタイムに近い形で情報を検知できる。

---

## 3. データ取得戦略：Yahoo!リアルタイム検索の採用

### X APIを利用しない理由
X（旧Twitter）の公式APIは、以下の観点からMVPフェーズでの採用を見送る。
1.  **コスト:** 実用的な取得数（Read）を確保するための有料プラン（Basic/Pro）が高額である。→確か20000万/月
2.  **API制限:** 無料枠ではRate Limitだとxの投稿内容の取得機能がなく、システム要件を満たせない。

### 決定事項：Yahoo!検索（リアルタイム検索）のスクレイピング
Xの投稿がインデックスされている「Yahoo!リアルタイム検索」をデータソースとする。
* 理由: 
    * xの有料APIと同等の機能（投稿内容の取得）を使用することができる
    * 無料で使える

---

## 4. スクレイピングにおける制約事項と対策

Yahoo!検索をスクレイピングするにあたり、以下の制約を認識し、許容または対策を行う。

* **DOM構造の変更リスク**
    * Yahoo側のHTML構造（クラス名など）が変更された場合、データ取得が失敗する。
        * 対策: エラー検知アラートを実装し、構造変更時に迅速に修正対応できる体制をとる。
* **アクセス制限（IP BAN）**
    * 短時間に大量のリクエストを送ると、Yahoo側からBot判定されアクセスが遮断される可能性がある
        * 対策: リクエスト間隔（Wait）を適切に設ける。また、必要に応じてIPローテーションを検討する。
    * 一回あたりに12投稿しか取得できない
        * 対策: 10分おきに取得実行するようにする（取得範囲の時間指定などはできない）

---

## 5. 技術選定：GASではなく Node.js + AWS を採用する理由

データ収集基盤として、手軽な Google Apps Script (GAS) ではなく、**Node.js + AWS** の構成を採用する。

### GASを採用しない理由（Google検知リスクと技術的限界）
1.  **Google IP帯域の制限:**
    GASからのアクセスはGoogleのサーバー（特定のIP帯域）を経由するため、Yahoo等の大手サイトはこれを「Bot」として容易に検知・遮断（403 Forbidden）される。→GASからのスクレイピングが不可能

### Node.js + AWS を選定する理由
1.  **高度なスクレイピング環境:**
    Node.js環境であれば `Puppeteer` や `Playwright` などのライブラリを使用でき、人間らしい挙動（Bot判定されにくい）を実装可能
2.  **スケーラビリティ:**
    将来的に監視対象のキーワードや店舗が増加した場合でも、リソースの拡張が容易である。

---

## 6. まとめ
本方針に基づき、**「Yahoo!リアルタイム検索をターゲットとし、Node.js + AWS環境で構築するスクレイピングシステム」**としてMVP開発に着手する。